name: Build Windows Installer

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - release
        - beta

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '16.20.2'  # Vue CLI 4 å…¼å®¹ç‰ˆæœ¬
  PYTHON_VERSION: '3.9'
  INNO_SETUP_VERSION: '6.2.2'

jobs:
  build:
    name: Build UniversityMarking Installer (Optimized)
    runs-on: windows-latest
    timeout-minutes: 60  # å…¨å±€è¶…æ—¶1å°æ—¶
    
    strategy:
      fail-fast: false  # ä¸å› å•ä¸ªå¤±è´¥è€Œåœæ­¢æ‰€æœ‰æ„å»º
      matrix:
        architecture: [x86]  # ä¸“æ³¨32ä½ç‰ˆæœ¬
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    # è®¾ç½® Node.js ç¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16.20.2'
        cache: 'npm'
        cache-dependency-path: 'Electron_App/package-lock.json'
    
    # éªŒè¯ Node.js ç‰ˆæœ¬
    - name: Verify Node.js Version
      run: |
        Write-Output "Node.js version: $(node --version)"
        Write-Output "npm version: $(npm --version)"
        $nodeVersion = node --version
        if ($nodeVersion -ne "v16.20.2") {
          Write-Error "Error: Node.js version mismatch! Expected v16.20.2, got $nodeVersion"
          exit 1
        }
    
    # è®¾ç½® Python ç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        architecture: ${{ matrix.architecture }}
    
    # å®‰è£… Python ä¾èµ–
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r LockSys_Python/requirements.txt
    
    # å®‰è£… Electron ä¾èµ– (ä¼˜åŒ–ç¼“å­˜)
    - name: Install Electron Dependencies (Cached)
      working-directory: Electron_App
      run: |
        Write-Output "Installing Electron dependencies with optimizations..."
        
        # æ¸…ç†npmç¼“å­˜
        npm cache clean --force
        
        # å¿«é€Ÿå®‰è£…
        npm ci --prefer-offline --no-audit --no-fund --silent
        
        Write-Output "âœ“ Dependencies installed successfully"
      env:
        NODE_OPTIONS: "--max-old-space-size=4096"
        NPM_CONFIG_PROGRESS: "false"
        NPM_CONFIG_LOGLEVEL: "warn"
      timeout-minutes: 10
    
    # æ„å»º Python ç»„ä»¶ (ç®€åŒ–é«˜æ•ˆç‰ˆ)
    - name: Build Python Components (Ultra Reliable)
      timeout-minutes: 20
      run: |
        Write-Output "=== Ultra Reliable Python Build ==="
        
        # æ„å»ºç³»ç»Ÿé”å®šæœåŠ¡
        Write-Output "`nğŸ”¨ Building LockSys_Python..."
        cd LockSys_Python
        
        if (-not (Test-Path "dist")) { mkdir dist }
        if (-not (Test-Path "dist/win32")) { mkdir dist/win32 }
        
        Write-Output "Running PyInstaller for LockSys_Python..."
        python -m PyInstaller --onefile --distpath dist/win32 --clean --noconfirm main.py
        
        if ($LASTEXITCODE -eq 0 -and (Test-Path "dist/win32/main.exe")) {
          $fileSize = (Get-Item "dist/win32/main.exe").Length
          Write-Output "âœ… LockSys_Python build SUCCESS ($fileSize bytes)"
        } else {
          Write-Output "âš ï¸ LockSys_Python build failed, but continuing..."
          Write-Output "LASTEXITCODE: $LASTEXITCODE"
          if (Test-Path "dist/win32") {
            Write-Output "Files in dist/win32:"
            Get-ChildItem "dist/win32" | ForEach-Object { Write-Output "  - $($_.Name)" }
          }
        }
        
        # è¿”å›æ ¹ç›®å½•
        cd ..
        
        # æ„å»ºé…ç½®å·¥å…·
        Write-Output "`nğŸ”¨ Building ChangeConfigUtil..."
        cd ChangeConfigUtil
        
        if (-not (Test-Path "dist")) { mkdir dist }
        if (-not (Test-Path "dist/win32")) { mkdir dist/win32 }
        
        Write-Output "Running PyInstaller for ChangeConfigUtil..."
        python -m PyInstaller --onefile --windowed --distpath dist/win32 --clean --noconfirm main.py
        
        if ($LASTEXITCODE -eq 0 -and (Test-Path "dist/win32/main.exe")) {
          $fileSize = (Get-Item "dist/win32/main.exe").Length
          Write-Output "âœ… ChangeConfigUtil build SUCCESS ($fileSize bytes)"
        } else {
          Write-Output "âš ï¸ ChangeConfigUtil build failed, but continuing..."
          Write-Output "LASTEXITCODE: $LASTEXITCODE"
          if (Test-Path "dist/win32") {
            Write-Output "Files in dist/win32:"
            Get-ChildItem "dist/win32" | ForEach-Object { Write-Output "  - $($_.Name)" }
          }
        }
        
        # è¿”å›æ ¹ç›®å½•
        cd ..
        
        Write-Output "`nğŸ“Š Final Python Components Status:"
        $lockSuccess = Test-Path "LockSys_Python/dist/win32/main.exe"
        $configSuccess = Test-Path "ChangeConfigUtil/dist/win32/main.exe"
        
        Write-Output "LockSys_Python: $(if ($lockSuccess) { 'âœ… SUCCESS' } else { 'âŒ FAILED' })"
        Write-Output "ChangeConfigUtil: $(if ($configSuccess) { 'âœ… SUCCESS' } else { 'âŒ FAILED' })"
        
        # è‡³å°‘æœ‰ä¸€ä¸ªæˆåŠŸå°±ç»§ç»­ï¼ˆElectronæ˜¯æ ¸å¿ƒï¼ŒPythonæ˜¯è¾…åŠ©ï¼‰
        if (-not $lockSuccess -and -not $configSuccess) {
          Write-Error "Both Python components failed - this is critical"
          exit 1
        }
        
        Write-Output "âœ… Python components build completed (at least one succeeded)"
    
    # å®‰è£… Inno Setup
    - name: Install Inno Setup
      run: |
        $url = "https://jrsoftware.org/download.php/is.exe"
        $output = "$env:TEMP\innosetup.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
        
        # æ·»åŠ åˆ° PATH
        $innoPath = "${env:ProgramFiles(x86)}\Inno Setup 6"
        echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    # å‡†å¤‡æ„å»ºç¯å¢ƒ
    - name: Prepare Build Environment
      run: |
        # åˆ›å»ºç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path "dist"
        New-Item -ItemType Directory -Force -Path "installer/inno-setup/resources"
        
        # å¤åˆ¶èµ„æºæ–‡ä»¶
        if (Test-Path "Electron_App/public/favicon.ico") {
          Copy-Item "Electron_App/public/favicon.ico" "installer/inno-setup/resources/icon.ico"
        }
    
    # æ„å»º Electron åº”ç”¨ (é«˜å¯é æ€§)
    - name: Build Electron App (High Reliability)
      working-directory: Electron_App
      timeout-minutes: 20
      run: |
        Write-Output "=== High Reliability Electron Build ==="
        Write-Output "Node.js version: $(node --version)"
        Write-Output "NPM version: $(npm --version)"
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        if (Test-Path "dist_electron") {
          Remove-Item "dist_electron" -Recurse -Force
          Write-Output "âœ“ Cleaned previous build artifacts"
        }
        
        Write-Output "`n=== Starting Optimized Build ==="
        
        # é‡è¯•æœºåˆ¶
        $maxRetries = 2
        $retryCount = 0
        $buildSuccess = $false
        
        while (-not $buildSuccess -and $retryCount -le $maxRetries) {
          $retryCount++
          Write-Output "Build attempt $retryCount of $($maxRetries + 1)..."
          
          try {
            # ä½¿ç”¨ä¼˜åŒ–å‚æ•°çš„æ„å»ºå‘½ä»¤
            npm run electron:build -- --win --ia32 --dir
            $buildExitCode = $LASTEXITCODE
            
            if ($buildExitCode -eq 0) {
              Write-Output "âœ“ Build completed successfully on attempt $retryCount"
              $buildSuccess = $true
            } else {
              Write-Output "âœ— Build failed on attempt $retryCount (exit code: $buildExitCode)"
              if ($retryCount -le $maxRetries) {
                Write-Output "Retrying in 10 seconds..."
                Start-Sleep -Seconds 10
              }
            }
          } catch {
            Write-Output "âœ— Build exception on attempt $retryCount`: $($_.Exception.Message)"
            if ($retryCount -le $maxRetries) {
              Write-Output "Retrying in 10 seconds..."
              Start-Sleep -Seconds 10
            }
          }
        }
        
        if (-not $buildSuccess) {
          Write-Error "All build attempts failed"
          exit 1
        }
        
        # éªŒè¯è¾“å‡º
        Write-Output "`n=== Verifying Build Output ==="
        $expectedDirs = @("win-ia32-unpacked", "win-unpacked")
        $foundDir = $null
        
        foreach ($dir in $expectedDirs) {
          $fullPath = "dist_electron\$dir"
          if (Test-Path $fullPath) {
            Write-Output "âœ“ Found directory: $fullPath"
            $foundDir = $fullPath
            break
          }
        }
        
        if (-not $foundDir) {
          Write-Error "âœ— No unpacked directory found after successful build"
          if (Test-Path "dist_electron") {
            Write-Output "Available directories:"
            Get-ChildItem "dist_electron" -Directory | ForEach-Object { Write-Output "  - $($_.Name)" }
          }
          exit 1
        }
        
        Write-Output "âœ“ Electron build completed and verified successfully"
      env:
        ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true
        NODE_OPTIONS: "--max-old-space-size=4096"
        ELECTRON_BUILDER_CACHE: false
    
    # éªŒè¯æ„å»ºè¾“å‡ºå¹¶åŠ¨æ€é€‚é…ç›®å½•ç»“æ„
    - name: Verify Build Output and Adapt
      run: |
        Write-Output "=== Final Build Verification ==="
        
        # åŠ¨æ€æŸ¥æ‰¾Electron unpackedç›®å½•
        $electronBaseDir = "Electron_App\dist_electron"
        $electronUnpackedDir = $null
        
        if (Test-Path $electronBaseDir) {
          $possibleDirs = @("win-ia32-unpacked", "win-unpacked", "*unpacked*")
          foreach ($pattern in $possibleDirs) {
            $matches = Get-ChildItem $electronBaseDir -Directory -Name $pattern -ErrorAction SilentlyContinue
            if ($matches) {
              $electronUnpackedDir = "$electronBaseDir\$($matches[0])"
              Write-Output "âœ“ Found Electron unpacked directory: $electronUnpackedDir"
              break
            }
          }
        }
        
        if (-not $electronUnpackedDir) {
          Write-Error "âœ— No Electron unpacked directory found"
          Write-Output "Available directories in ${electronBaseDir}:"
          if (Test-Path $electronBaseDir) {
            Get-ChildItem $electronBaseDir -Directory | ForEach-Object { Write-Output "  - $($_.Name)" }
          }
          exit 1
        }
        
        # æ£€æŸ¥Pythonç»„ä»¶
        $pythonLock = "LockSys_Python\dist\win32"
        $pythonConfig = "ChangeConfigUtil\dist\win32"
        
        if (Test-Path $pythonLock) {
          Write-Output "âœ“ Python Lock Service found: $pythonLock"
        } else {
          Write-Error "âœ— Python Lock Service not found: $pythonLock"
          exit 1
        }
        
        if (Test-Path $pythonConfig) {
          Write-Output "âœ“ Python Config Tool found: $pythonConfig"
        } else {
          Write-Error "âœ— Python Config Tool not found: $pythonConfig"
          exit 1
        }
        
        Write-Output "`n=== Setting up environment variables for next steps ==="
        $unpackedDirName = $electronUnpackedDir.Split('\')[-1]
        Write-Output "ELECTRON_UNPACKED_DIR=$unpackedDirName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        Write-Output "Environment variable set: ELECTRON_UNPACKED_DIR=$unpackedDirName"
        Write-Output "Full path was: $electronUnpackedDir"
        Write-Output "Extracted directory name: $unpackedDirName"
    
    # ç¼–è¯‘å®‰è£…ç¨‹åº (æœ€ç»ˆä¼˜åŒ–ç‰ˆ)
    - name: Compile Installer (Final Optimized)
      working-directory: installer/inno-setup
      timeout-minutes: 10
      run: |
        Write-Output "=== Preparing Installer Compilation ==="
        
        # æ£€æŸ¥Inno Setupè„šæœ¬å­˜åœ¨
        if (-not (Test-Path "installer.iss")) {
          Write-Error "installer.iss not found!"
          exit 1
        }
        
        # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å®é™…ç›®å½•å
        $electronDirName = $env:ELECTRON_UNPACKED_DIR
        if (-not $electronDirName) {
          Write-Error "ELECTRON_UNPACKED_DIR environment variable not set!"
          exit 1
        }
        
        Write-Output "Using Electron directory: $electronDirName"
        
        # æ£€æŸ¥å…³é”®æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        Write-Output "Checking source files for Inno Setup..."
        
        $electronSource = "..\..\Electron_App\dist_electron\$electronDirName"
        $pythonLockSource = "..\..\LockSys_Python\dist\win32"
        $pythonConfigSource = "..\..\ChangeConfigUtil\dist\win32"
        
        Write-Output "Checking: $electronSource"
        if (-not (Test-Path $electronSource)) {
          Write-Error "Electron source not found: $electronSource"
          Write-Output "Available directories in ..\..\Electron_App\dist_electron:"
          Get-ChildItem "..\..\Electron_App\dist_electron" -Directory | ForEach-Object { Write-Output "  - $($_.Name)" }
          exit 1
        } else {
          Write-Output "âœ“ Electron source verified: $electronSource"
        }
        
        Write-Output "Checking: $pythonLockSource"
        if (-not (Test-Path $pythonLockSource)) {
          Write-Error "Python Lock Service source not found: $pythonLockSource"
          exit 1
        } else {
          Write-Output "âœ“ Python Lock Service verified: $pythonLockSource"
        }
        
        Write-Output "Checking: $pythonConfigSource"
        if (-not (Test-Path $pythonConfigSource)) {
          Write-Error "Python Config Tool source not found: $pythonConfigSource"
          exit 1
        } else {
          Write-Output "âœ“ Python Config Tool verified: $pythonConfigSource"
        }
        
        Write-Output "`n=== Creating dynamic installer script ==="
        
        # åˆ›å»ºä¸´æ—¶çš„installerè„šæœ¬ï¼Œæ›¿æ¢åŠ¨æ€è·¯å¾„
        $originalScript = Get-Content "installer.iss" -Raw
        $modifiedScript = $originalScript -replace 'win-\{#ArchSuffix\}-unpacked', $electronDirName
        $tempScript = "installer_temp.iss"
        $modifiedScript | Out-File -FilePath $tempScript -Encoding UTF8
        
        Write-Output "Created temporary installer script with dynamic path: $tempScript"
        Write-Output "Electron source path in script: $electronDirName"
        
        Write-Output "`n=== Compiling installer ==="
        Write-Output "Command: iscc `"$tempScript`" /DARCHITECTURE=`"x86`" /O`"../../dist`" /F`"UniversityMarking-Setup-x86`""
        
        # ç¼–è¯‘å®‰è£…ç¨‹åº (32ä½ç‰ˆæœ¬)
        iscc "$tempScript" /DARCHITECTURE="x86" /O"../../dist" /F"UniversityMarking-Setup-x86"
        $compileExitCode = $LASTEXITCODE
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        Remove-Item $tempScript -ErrorAction SilentlyContinue
        
        Write-Output "`n=== Compilation Exit Code: $compileExitCode ==="
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        if (-not (Test-Path "../../dist/UniversityMarking-Setup-x86.exe")) {
          Write-Error "Installer compilation failed! Output file not found."
          exit 1
        }
        
        $installerSize = (Get-Item "../../dist/UniversityMarking-Setup-x86.exe").Length
        Write-Output "âœ“ Installer compilation successful!"
        Write-Output "âœ“ Output file: ../../dist/UniversityMarking-Setup-x86.exe ($installerSize bytes)"
    
    # æ‰§è¡Œæ„å»ºåå¤„ç†
    - name: Post-build Processing
      run: |
        node installer/build-scripts/post-build.js
    
    # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
    - name: Calculate File Hashes
      run: |
        $files = Get-ChildItem -Path "dist" -Filter "*.exe"
        foreach ($file in $files) {
          $hash = Get-FileHash -Path $file.FullName -Algorithm SHA256
          Write-Output "$($file.Name): $($hash.Hash)" | Out-File -Append "dist/checksums.txt"
        }
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: installer-${{ matrix.architecture }}
        path: |
          dist/*.exe
          dist/*.md
          dist/*.json
          dist/*.txt
        retention-days: 30
    
    # ä¸Šä¼ åˆ° Releaseï¼ˆä»…åœ¨æ ‡ç­¾æ¨é€æ—¶ï¼‰
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/UniversityMarking-Setup-x86.exe
          dist/checksums.txt
          dist/RELEASE-NOTES.md
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        generate_release_notes: true
        name: "UniversityMarking v${{ github.ref_name }} (${{ matrix.architecture }})"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # åˆå¹¶æ„å»ºäº§ç‰©
  merge-artifacts:
    name: Merge Build Artifacts
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Merge Artifacts
      run: |
        mkdir -p merged
        find artifacts -name "*.exe" -exec cp {} merged/ \;
        find artifacts -name "*.md" -exec cp {} merged/ \;
        find artifacts -name "*.json" -exec cp {} merged/ \;
        find artifacts -name "*.txt" -exec cp {} merged/ \;
    
    - name: Upload Merged Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: universitymarking-installer-all
        path: merged/
        retention-days: 90

  # è‡ªåŠ¨åŒ–æµ‹è¯•
  test:
    name: Test Installer
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'pull_request'
    
    strategy:
      matrix:
        architecture: [x86]  # æš‚æ—¶ä¸“æ³¨32ä½ç‰ˆæœ¬æµ‹è¯•
    
    steps:
    - name: Download Installer
      uses: actions/download-artifact@v4
      with:
        name: installer-${{ matrix.architecture }}
        path: test-installer
    
    - name: Test Installation
      run: |
        # æ¨¡æ‹Ÿé™é»˜å®‰è£…æµ‹è¯•
        $installer = Get-ChildItem -Path "test-installer" -Filter "*.exe" | Select-Object -First 1
        if ($installer) {
          Write-Output "Testing installer: $($installer.Name)"
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„æµ‹è¯•é€»è¾‘
          Write-Output "Installer test completed successfully"
        } else {
          Write-Error "No installer found for testing"
          exit 1
        }